<ng-container 
  *ngIf="renderReady && canDisplayOptions && optionsToDisplay?.length > 0; else noOptions"
  [style.visibility]="finalRenderReady ? 'visible' : 'hidden'"
  [style.minHeight]="'1rem'">

  <form [formGroup]="form" class="options-form">

    <!-- SINGLE-ANSWER (radio) -->
    <mat-radio-group
    *ngIf="type === 'single'"
    class="options-group options single-option"
    formControlName="selectedOptionId"
  >
    <div
      *ngFor="let b of optionBindings; let i = index; trackBy: trackByOptionId"
      class="option-container"
    >
      <mat-radio-button
        [value]="b.option.optionId"
        class="option-radio"
        (click)="handleClick(b, i)"
        (change)="updateOptionAndUI(b, i, $event)"
      >
        <label
          appHighlightOption
          [option]="b.option"
          [optionBinding]="b"
          [isSelected]="b.isSelected"
          [isCorrect]="b.isCorrect"
          [selectedOptionHistory]="selectedOptionHistory"
          [showFeedback]="showFeedback"
          [showFeedbackForOption]="showFeedbackForOption"
          [highlightCorrectAfterIncorrect]="highlightCorrectAfterIncorrect"
          [allOptions]="optionsToDisplay"
          [optionsToDisplay]="optionsToDisplay"
          [attr.data-option-id]="b.option.optionId"
          [ngClass]="b.styleClass"
          [appHighlightInputType]="'radio'"
          [appHighlightReset]="shouldResetBackground"
          [appResetBackground]="shouldResetBackground"
        >
          <span class="option-text">
            {{ getOptionDisplayText(b.option, i) }}
          </span>
  
          <mat-icon *ngIf="shouldShowIcon(b.option)" class="opt-icon">
            {{ getOptionIcon(b.option) }}
          </mat-icon>
        </label>
      </mat-radio-button>
  
      <!-- âœ… Feedback shown below the radio button -->
      <div *ngIf="showFeedbackForOption[b.option.optionId]" class="feedback-wrapper">
        <codelab-quiz-feedback
          *ngIf="b.option.optionId === lastFeedbackOptionId"
          [feedbackConfig]="feedbackConfigs[b.option.optionId]"
        ></codelab-quiz-feedback>
      </div>
    </div>
  </mat-radio-group>

    <!-- MULTIPLE-ANSWER (checkbox) -->
    <div *ngIf="type === 'multiple'" class="options-group options multiple-option">
      <div
        *ngFor="let b of optionBindings; let i = index; trackBy: trackByOptionId"
        class="option-row">

        <label
          class="option-row options"
          appHighlightOption
          [option]="b.option"
          [optionBinding]="b"
          [isSelected]="b.isSelected"
          [isCorrect]="b.isCorrect"
          [selectedOptionHistory]="selectedOptionHistory"
          [showFeedback]="showFeedback"
          [showFeedbackForOption]="showFeedbackForOption"
          [highlightCorrectAfterIncorrect]="highlightCorrectAfterIncorrect"
          [allOptions]="optionsToDisplay"
          [optionsToDisplay]="optionsToDisplay"
          [attr.data-option-id]="b.option.optionId"
          [ngClass]="b.styleClass"
          [appHighlightInputType]="'checkbox'"
          [appHighlightReset]="shouldResetBackground"
          [appResetBackground]="shouldResetBackground"
        >

          <mat-checkbox
            [checked]="b.option.selected"
            [value]="b.option.optionId"
            (change)="updateOptionAndUI($event)"
            [selectedOptionHistory]="selectedOptionHistory"
            (click)="handleClick(b, i)"
            (change)="updateOptionAndUI(b, i, $event)">

            <span class="option-text">
              {{ getOptionDisplayText(b.option, i) }}
            </span>

            <mat-icon *ngIf="shouldShowIcon(b.option)" class="opt-icon">
              {{ getOptionIcon(b.option) }}
            </mat-icon>

            <div class="feedback-text" *ngIf="showFeedbackForOption[b.option.optionId]">
              {{ feedbackConfigs[b.option.optionId]?.feedback }}
            </div>
          </mat-checkbox>
        </label>

        <!-- TEMP DEBUG -->
        <!--<p *ngIf="feedbackConfigs[b.option.optionId]">[ðŸ§ª Feedback Raw]: {{ feedbackConfigs[b.option.optionId]?.feedback }}</p>

        <div class="feedback-text" *ngIf="feedbackConfig?.feedback">
          {{ feedbackConfig.feedback }}
        </div>

        <p style="color: red;">
          DEBUG: {{ feedbackConfigs[b.option.optionId]?.feedback }}
        </p>-->
        
        
          <!-- âœ… FORCED TEST RENDER -->
          <!--<codelab-quiz-feedback
            *ngIf="true"
            [feedbackConfig]="{
              feedback: 'âœ… TEST MESSAGE',
              showFeedback: true,
              selectedOption: { correct: true }
            }">
          </codelab-quiz-feedback>-->


         <!--<codelab-quiz-feedback
          *ngIf="showFeedbackForOption[b.option.optionId]"
          [feedbackConfig]="feedbackConfigs[b.option.optionId]">
        </codelab-quiz-feedback>-->     

        <!--<codelab-quiz-feedback
          *ngIf="shouldShowFeedback(i)"
          [feedbackConfig]="feedbackConfigs[b.option.optionId]">
        </codelab-quiz-feedback>-->

        <!--<div class="feedback-text"
          *ngIf="feedbackConfigs[b.option.optionId]?.feedback !== 'No feedback available'">
        {{ feedbackConfigs[b.option.optionId]?.feedback }}
        </div> -->
        
        <!--<codelab-quiz-feedback
          *ngIf="showFeedbackForOption[b.option.optionId]"
          [feedbackConfig]="feedbackConfigs[b.option.optionId]">
        </codelab-quiz-feedback>-->

        <ng-container *ngIf="feedbackConfigs[b.option.optionId]">
          <div *ngIf="feedbackConfigs[b.option.optionId]?.showFeedback" style="color: blue">
            FEEDBACK: {{ feedbackConfigs[b.option.optionId]?.feedback || 'No feedback set' }}
          </div>
        </ng-container>
        

      <div *ngIf="showFeedbackForOption[b.option.optionId] && feedbackConfigs[b.option.optionId]?.feedback">
      <p class="feedback-text">
        {{ feedbackConfigs[b.option.optionId].feedback }}
      </p>
      </div>

      </div>
    </div>
  </form>
</ng-container>

<ng-template #noOptions>
  <span style="min-height: 1rem;">Options not ready...</span>
</ng-template>
